<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>配管 切寸 計算</title>
  <style>
    :root {
      --fg:#111; --muted:#666; --bd:#e6e6e6; --bg:#fff; --soft:#f7f7f7; --warn-bg:#fff1f2; --warn-bd:#fecdd3; --warn-fg:#9f1239;
      --ok-bg:#f5f5f5; --radius:18px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, sans-serif; color:var(--fg); background:var(--bg); }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px 14px 28px; }
    h1 { font-size: 18px; margin: 6px 0 14px; }
    .card { border:1px solid var(--bd); border-radius: var(--radius); padding: 12px; background:#fff; }
    .stack { display:flex; flex-direction:column; gap: 12px; }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row { display:flex; gap: 8px; }
    .seg { display:flex; gap: 8px; }
    button {
      -webkit-tap-highlight-color: transparent;
      width: 100%;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid var(--bd);
      background: #fff;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.sel { border-color: #111; }
    .pill {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--bd);
      background: var(--soft);
      font-size: 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    input[type="number"] {
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--bd);
      font-size: 16px; /* iOS zoom回避 */
    }
    .unit { width: 96px; flex: 0 0 96px; text-align:center; }
    .result {
      background: var(--soft);
      border-radius: var(--radius);
      padding: 12px;
    }
    .result .big { font-size: 32px; font-weight: 700; line-height: 1.1; }
    .result .sub { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .warn {
      border: 1px solid var(--warn-bd);
      background: var(--warn-bg);
      color: var(--warn-fg);
      border-radius: var(--radius);
      padding: 12px;
      font-size: 14px;
    }
    .muted { color: var(--muted); font-size: 12px; }
    .actions { display:flex; gap: 10px; }
    .clear {
      border-color:#bbb; background:#fff;
      font-size: 15px;
    }
    .hint { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>配管 切寸 計算（シンプル）</h1>

    <div class="stack">
      <div class="card">
        <div class="label">口径（6択）</div>
        
        <div id="pipeBtns" class="grid2">
          <button data-pipe="20">20</button>
          <button data-pipe="25">25</button>
          <button data-pipe="30">30</button>
          <button data-pipe="40">40</button>
          <button data-pipe="50">50</button>
          <button data-pipe="60">60</button>
        </div>

      </div>

      <div class="card">
        <div class="label">条件（3択）</div>
        <div class="seg">
          <button id="condA">面々</button>
          <button id="condB">面芯</button>
          <button id="condC">芯々</button>
        </div>
        <div style="height:10px"></div>
        <div class="hint">※ 条件値は内部計算（表示しません）</div>
      </div>

      <div class="card">
        <div class="label">寸法入力</div>
        <div class="row">
          <input id="lenInput" type="text" inputmode="decimal" placeholder="例：120" />
          <button id="unitBtn" class="unit">mm</button>
        </div>
        <div style="height:10px"></div>
        <div class="actions">
          <button id="clearBtn" class="clear">クリア</button>
        </div>
        <div style="height:8px"></div>
        <div class="muted">単位は mm / m を切替できます。</div>
      </div>

      <div class="card">
        <div class="label">結果</div>
        <div class="result">
          <div class="big" id="resultBig">—</div>
          <div class="sub" id="resultSub">口径・条件・寸法を選ぶと表示します</div>
        </div>
        <div style="height:10px"></div>
        <div id="warnBox" style="display:none" class="warn"></div>
      </div>
    </div>
  </div>

<script>
  const DATA = [{"size": 20, "L1": -24.5, "S": 9.5, "minCut": 38}, {"size": 25, "L1": -31.0, "S": 10.0, "minCut": 42}, {"size": 30, "L1": -34.0, "S": 12.0, "minCut": 50}, {"size": 40, "L1": -38.0, "S": 14.0, "minCut": 60}, {"size": 50, "L1": -41.0, "S": 16.0, "minCut": 68}, {"size": 60, "L1": -44.5, "S": 19.5, "minCut": 82}];

  const pipes = DATA.map(d => d.size);
  const pipeMap = new Map(DATA.map(d => [String(d.size), d]));

  let state = {
    pipe: String(pipes[0]),
    cond: "A",     // A:面々 B:面芯 C:芯々
    unit: "mm",    // mm or m
    len: ""        // user input (string)
  };

  const pipeBtnsEl = document.getElementById("pipeBtns");
  // bind pipe buttons (static markup)
  [...pipeBtnsEl.querySelectorAll("button")].forEach(b => {
    b.addEventListener("click", () => {
      state.pipe = b.dataset.pipe;
      updateUI();
    });
  });

  const lenInput = document.getElementById("lenInput");
  const unitBtn = document.getElementById("unitBtn");
  const clearBtn = document.getElementById("clearBtn");
  const resultBig = document.getElementById("resultBig");
  const resultSub = document.getElementById("resultSub");
  const warnBox = document.getElementById("warnBox");

  const condBtns = {
    A: document.getElementById("condA"),
    B: document.getElementById("condB"),
    C: document.getElementById("condC"),
  };

    function setSelectedButtons() {
    // pipe
    [...pipeBtnsEl.querySelectorAll("button")].forEach(b => {
      b.classList.toggle("sel", b.dataset.pipe === state.pipe);
    });
    // cond
    Object.entries(condBtns).forEach(([k, btn]) => {
      btn.classList.toggle("sel", k === state.cond);
    });
    // unit
    unitBtn.textContent = state.unit;
  }

  function condValueFor(pipeRec, cond) {
    const L1 = Number(pipeRec.L1);
    const S  = Number(pipeRec.S);
    if (cond === "A") return 2 * S;        // 面々 = S+S
    if (cond === "B") return L1 + S;       // 面芯 = L1+S
    return 2 * L1;                          // 芯々 = L1+L1
  }

  function sanitizeNumber(raw) {
    // allow digits, one dot, and one leading minus; accept comma decimals
    let s = (raw ?? "").toString().trim().replace(/,/g, ".");
    // keep only digits, dot, minus
    s = s.replace(/[^0-9\.\-]/g, "");
    // if multiple dots, keep first
    const parts = s.split(".");
    if (parts.length > 2) s = parts[0] + "." + parts.slice(1).join("");
    // handle multiple minus: keep leading only
    s = s.replace(/(?!^)-/g, "");
    return s;
  }

  function parseLenToMm() {
    const cleaned = sanitizeNumber(state.len);
    if (!cleaned) return null;
    const n = Number(cleaned);
    if (!isFinite(n)) return null;
    // unit conversion: user input -> mm
    if (state.unit === "mm") return n;
    // m -> mm
    return n * 1000;
  }

  function formatOut(valueMm) {
    if (state.unit === "mm") {
      return { value: valueMm, unit: "mm" };
    }
    return { value: valueMm / 1000, unit: "m" };
  }

  function updateResult() {
    const pipeRec = pipeMap.get(state.pipe);
    if (!pipeRec) return;

    const lenMm = parseLenToMm();
    if (lenMm === null) {
      resultBig.textContent = "—";
      resultSub.textContent = "口径・条件・寸法を選ぶと表示します";
      warnBox.style.display = "none";
      return;
    }

    const cond = condValueFor(pipeRec, state.cond);
    const ansMm = lenMm + cond;

    const minMm = Number(pipeRec.minCut);
    const ansOut = formatOut(ansMm);
    const minOut = formatOut(minMm);

    // display
    const digits = (state.unit === "mm") ? 0 : 3;
    resultBig.textContent = ansOut.value.toFixed(digits) + " " + ansOut.unit;
    resultSub.textContent = "（最短切り: " + minOut.value.toFixed(digits) + " " + minOut.unit + "）";

    // warning
    if (ansMm < minMm) {
      const needMm = (minMm - ansMm);
      const needOut = formatOut(needMm);
      warnBox.style.display = "block";
      warnBox.textContent = "⚠ 最短切りに満たません。不足: +" + needOut.value.toFixed(digits) + " " + needOut.unit;
    } else {
      warnBox.style.display = "none";
    }
  }

  function updateUI() {
    setSelectedButtons();
    updateResult();
  }

  // events
  Object.entries(condBtns).forEach(([k, btn]) => {
    btn.addEventListener("click", () => {
      state.cond = k;
      updateUI();
    });
  });

  lenInput.addEventListener("input", (e) => {
    state.len = e.target.value;
    updateResult();
  });

  unitBtn.addEventListener("click", () => {
    // preserve the physical value when switching units
    const oldUnit = state.unit;
    const lenMm = parseLenToMm(); // based on current unit
    state.unit = (state.unit === "mm") ? "m" : "mm";

    if (lenMm !== null) {
      // convert mm -> new unit value and update input text
      if (state.unit === "mm") {
        state.len = String(Math.round(lenMm));
        lenInput.value = state.len;
      } else {
        const m = lenMm / 1000;
        // keep up to 3 decimals, trim trailing zeros
        let s = m.toFixed(3).replace(/\.?0+$/,"");
        state.len = s;
        lenInput.value = s;
      }
    }
    updateUI();
  });

  clearBtn.addEventListener("click", () => {
    state.pipe = String(pipes[0]);
    state.cond = "A";
    state.unit = "mm";
    state.len = "";
    lenInput.value = "";
    updateUI();
  });

  // init
  updateUI();
</script>
</body>
</html>
